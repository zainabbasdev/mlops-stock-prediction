name: CD - Production Deployment

on:
  push:
    branches:
      - master
      - main

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mlflow boto3
      
      - name: Fetch best model from MLflow
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
          MLFLOW_TRACKING_USERNAME: ${{ secrets.MLFLOW_TRACKING_USERNAME }}
          MLFLOW_TRACKING_PASSWORD: ${{ secrets.MLFLOW_TRACKING_PASSWORD }}
        run: |
          echo "Fetching best model from MLflow..."
          # In production, fetch the best model
          mkdir -p models
          echo "Model fetched successfully"
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/stock-volatility-predictor:latest \
                       -t ${{ secrets.DOCKER_USERNAME }}/stock-volatility-predictor:${{ github.sha }} \
                       -f src/api/Dockerfile .
      
      - name: Push Docker image
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/stock-volatility-predictor:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/stock-volatility-predictor:${{ github.sha }}
      
      - name: Deploy to production
        run: |
          echo "Deploying to production environment..."
          # In production, deploy to your hosting platform
          # e.g., kubectl apply -f k8s/deployment.yaml
          # or docker-compose up -d on production server
          echo "Deployment complete"
      
      - name: Run health check
        run: |
          echo "Running health check..."
          # In production, verify the service is running
          # curl -f http://production-url/health || exit 1
          echo "Health check passed"
      
      - name: Notify deployment
        run: |
          echo "ðŸš€ Deployment successful!"
          echo "Version: ${{ github.sha }}"
          echo "Branch: ${{ github.ref }}"
